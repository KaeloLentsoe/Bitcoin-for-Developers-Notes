# The Bitcoin Network

In the Bitcoin network, nodes play a pivotal role in maintaining the decentralized nature of the system. Each node acts as an individual computer participating in the network, performing various functions that collectively ensure the integrity and functionality of Bitcoin transactions. Here, we'll delve into the two primary functions of nodes: maintaining a copy of the blockchain and validating and propagating transaction data.

1. **Maintaining a Copy of the Blockchain:**
   The blockchain is the backbone of the Bitcoin network, serving as a public ledger that records all transactions ever executed. Nodes are responsible for storing and updating copies of the entire blockchain. This involves downloading new blocks as they are generated by miners and verifying their validity by checking cryptographic proofs and consensus rules. By maintaining a complete copy of the blockchain, nodes contribute to the network's resilience and transparency.

2. **Validating and Propagating Transaction Data:**
   Nodes play a crucial role in validating and propagating transactions across the network. When a user initiates a Bitcoin transaction, it is broadcasted to the network and picked up by nodes. These nodes verify the transaction's legitimacy by confirming that the sender has sufficient funds, adheres to protocol rules, and hasn't double-spent the coins. Once validated, the transaction is propagated to other nodes, ensuring its inclusion in the next block. This validation process helps prevent fraud and ensures the integrity of the Bitcoin network.

In addition to these core functions, nodes also serve as communication hubs within the network, relaying information between users, miners, and other nodes. They facilitate consensus among participants by enforcing protocol rules and signaling discrepancies or irregularities. Furthermore, nodes can vary in their roles and configurations, with some dedicated to mining (creating new blocks) and others focused solely on relaying transactions and maintaining the blockchain.

The decentralized nature of the Bitcoin network hinges on the collective efforts of nodes, each contributing to the system's security, reliability, and efficiency. Understanding the roles and responsibilities of nodes is essential for grasping the underlying mechanics of Bitcoin and appreciating its innovative approach to peer-to-peer transactions.

# Peer-to-Peer Network Architecture
The peer-to-peer (P2P) network architecture forms the foundational structure of Bitcoin, enabling its decentralized and resilient nature. Here's a breakdown of key points regarding Bitcoin's P2P network architecture:

1. **Equal Peers and Flat Topology:**
   In a P2P network like Bitcoin, all participating computers, or nodes, are considered equal peers. There are no special nodes, servers, or centralized services. The network is organized in a mesh topology with a flat structure, meaning there's no hierarchy among the nodes.

2. **Decentralization and Openness:**
   P2P networks like Bitcoin are inherently decentralized and open. Decentralization ensures that control is distributed across the network rather than concentrated in a single entity, enhancing resilience against censorship, manipulation, or failure. The openness of the network allows any node to join or leave freely, fostering inclusivity and adaptability.

3. **Reciprocity and Incentivization:**
   Nodes in a P2P network both provide and consume services simultaneously. Reciprocity acts as the incentive for participation, as nodes contribute to the network's functionality while benefiting from the services provided by other nodes. In the context of Bitcoin, this reciprocity is evident in activities such as relaying transactions, validating blocks, and maintaining the blockchain.

4. **Bitcoin's Design as a P2P Digital Cash System:**
   Bitcoin's P2P network architecture is intricately tied to its role as a digital cash system. The decentralized and flat-topology nature of the network reflects the core design principle of decentralization of control. This design is essential for achieving and maintaining the trustless and censorship-resistant characteristics of Bitcoin.

5. **Extended Bitcoin Network:**
   The term "bitcoin network" encompasses the collection of nodes running the Bitcoin P2P protocol. Additionally, there are other protocols such as Stratum used for mining and lightweight wallets. Gateway routing servers facilitate communication between nodes using different protocols, extending the Bitcoin network to include these additional protocols. The extended Bitcoin network includes the Bitcoin P2P protocol, pool-mining protocols, Stratum protocol, and any related protocols connecting various components of the Bitcoin system.

In conclusion, Bitcoin's P2P network architecture is fundamental to its functioning as a decentralized digital currency. It not only ensures the integrity and security of transactions but also embodies the core principles of decentralization, openness, and resilience.


# Node Types and Roles
A nodes in the bitcoin P2P network are equal, they may take on different roles depending on the functionality they are supporting. A bitcoin node is a collection of functions: routing, the blockchain database, mining, and wallet services. 

![nodes](/nde.png)

- **Bitcoin Node Functions**:
  - **Routing**: All nodes participate in network routing.
  - **Blockchain Database**: Some nodes maintain a complete copy of the blockchain.
  - **Mining**: Nodes compete to create new blocks through Proof-of-Work.
  - **Wallet Services**: Nodes may host user wallets.

- **Full Nodes**:
  - **Description**: Maintain a complete and up-to-date copy of the blockchain.
  - **Functionality**: Can autonomously verify any transaction without external reference.
  - **Representation**: Indicated with a circle labeled "Full Blockchain" or the letter "B".

- **SPV (Simplified Payment Verification) Nodes**:
  - **Description**: Maintain only a subset of the blockchain.
  - **Functionality**: Verify transactions using SPV method.
  - **Representation**: Shown without the "B" circle, indicating incomplete blockchain copy.

- **Mining Nodes**:
  - **Description**: Compete to create new blocks through specialized hardware.
  - **Variety**: Some are full nodes, others participate in pool mining.
  - **Representation**: Depicted as a circle labeled "Miner" or the letter "M".

- **Wallet Nodes**:
  - **Description**: Store user wallets, may be part of full nodes or standalone.
  - **Variety**: Often included in desktop bitcoin clients or as SPV nodes on smartphones.
  - **Representation**: Shown as a circle labeled "Wallet" or the letter "W".

- **Other Node Types**:
  - **Description**: Servers and nodes running specialized protocols.
  - **Variety**: Include specialized mining pool protocols and lightweight client-access protocols.

### Examples:

1. **Full Node**:
   - **Functionality**: Maintains complete blockchain.
   - **Representation**: Circle labeled "Full Blockchain" or "B".

2. **SPV Node**:
   - **Functionality**: Maintains subset of blockchain.
   - **Representation**: Shown without "B" circle.

3. **Mining Node**:
   - **Functionality**: Competes in block creation.
   - **Representation**: Circle labeled "Miner" or "M".

4. **Wallet Node**:
   - **Functionality**: Hosts user wallets.
   - **Representation**: Circle labeled "Wallet" or "W".

5. **Other Node Types**:
   - **Description**: Servers and specialized protocols.
   - **Variety**: Mining pool protocols, lightweight client-access protocols.

   # The Extended Bitcoin Network

   Notes:

- **Main Bitcoin Network**:
  - Consists of around 5,000 to 8,000 listening nodes primarily using Bitcoin Core.
  - Examples of implementations: Bitcoin Core, Bitcoin Classic, Bitcoin Unlimited, BitcoinJ, Libbitcoin, btcd, and bcoin.
  - Includes mining nodes participating in the mining process and validating transactions.
  - Large companies run full-node clients (e.g., Bitcoin Core) for network connectivity, without mining or wallet functions.

- **Extended Bitcoin Network**:
  - Incorporates specialized protocols alongside the main Bitcoin P2P network.
  - Features pool servers and protocol gateways linking nodes with different protocols.
  - Mainly comprises pool mining nodes and lightweight wallet clients lacking a full blockchain copy.

- **Components of the Extended Bitcoin Network**:
  - Node Types:
    - Listening nodes: Run various Bitcoin implementations.
    - Pool mining nodes: Participate in pooled mining activities.
    - Edge routers: Operated by large companies for network connectivity.
  - Gateways and Protocols:
    - Pool servers: Coordinate mining activities within mining pools.
    - Protocol gateways: Facilitate communication between nodes using different protocols.
    - Examples of protocols: Bitcoin Core, Bitcoin Classic, Bitcoin Unlimited, etc.
  - Functions:
    - Competing in mining, validating transactions, creating new blocks.
    - Enabling exchanges, wallets, block explorers, and merchant payment processing.

    ![nodes](/nodes%202.png)

    ### Figure 2. Different types of nodes on the extended bitcoin network

    ![nodes](/node%203.png)


   # Bitcoin Relay Networks

- **Purpose**: Bitcoin Relay Networks aim to minimize network latency for mining nodes, crucial for their time-sensitive competition to solve the Proof-of-Work problem and extend the blockchain.

- **Bitcoin P2P Network**: While the general P2P network serves various node types, it exhibits high latency for mining nodes, directly impacting their profit margins.

- **Original Bitcoin Relay Network (2015)**:
  - **Creator**: Core developer Matt Corallo.
  - **Infrastructure**: Hosted on Amazon Web Services globally.
  - **Functionality**: Enabled fast block synchronization between miners with low latency, connecting the majority of miners and mining pools.

- **Fast Internet Bitcoin Relay Engine (FIBRE) - 2016**:
  - **Creator**: Matt Corallo.
  - **Technology**: UDP-based relay network.
  - **Optimization**: Implements compact block optimization to reduce data transmission and further minimize network latency.

- **Role of Relay Networks**:
  - They serve as overlay networks, providing additional connectivity for nodes with specialized needs, without replacing the primary P2P network.
  - Analogous to freeways in a transportation network, offering faster routes for specific traffic (mining nodes), while the primary network serves as rural roads.

  # Network Discovery

  The process of network discovery for a new Bitcoin node involves several steps:

  Sure, here's a step-by-step breakdown with examples:

1. **Initial Bootstrapping**: Imagine a new Bitcoin node, Node A, coming online for the first time. It needs to discover other nodes on the network to join the Bitcoin network. Node A randomly selects an existing node, Node B, from a list of DNS seeds or from a provided IP address.

2. **Connection Establishment**: Node A establishes a TCP connection to Node B, usually on port 8333, and initiates a handshake by sending a version message:

```plaintext
Version Message from Node A to Node B:
- Protocol Version: 70002
- Supported Services: NODE_NETWORK
- Current Time: [timestamp]
- IP Address of Node A: [Node A's IP]
- IP Address of Node B: [Node B's IP]
- Software Version: /Satoshi:0.9.2.1/
- Blockchain Height: [height]
```

3. **Version Message Exchange**: Node B receives the version message from Node A, checks compatibility, and if compatible, sends a verack message to acknowledge and establish the connection.

```plaintext
Verack Message from Node B to Node A:
- Acknowledgment of Version Message
```

4. **DNS Querying**: If Node A used DNS querying, it would have sent DNS requests to DNS seeds to obtain IP addresses of other Bitcoin nodes. For example:

```plaintext
DNS Query to DNS Seed:
- Requesting Bitcoin Node Addresses
- DNS Seed Responds with List of IP Addresses
```

5. **Seed Node Connection**: Alternatively, if Node A was given the IP address of a seed node, it would connect to it and request introductions to other nodes. For example:

```plaintext
Connection to Seed Node:
- Node A connects to Seed Node C (IP: [Seed Node C's IP])
- Seed Node C provides introductions to Node A:
  - Introduce Node A to Node D (IP: [Node D's IP])
  - Introduce Node A to Node E (IP: [Node E's IP])
- Node A disconnects from Seed Node C and connects to Node D and Node E for further interactions.
```

In this way, Node A discovers and connects to other nodes on the Bitcoin network through a combination of DNS querying and seed node connections.

### Figure 4. The initial handshake between peers

![nodes](/figure.png)


6. **Address Propagation and Discovery**: Once one or more connections are established, the new node starts actively participating in the network by sending an addr message containing its own IP address to its connected peers.

```plaintext
Addr Message from Node A to Node B:
- Node A's IP Address: [Node A's IP]
```

7. **Address Forwarding**: Node B, upon receiving the addr message from Node A, forwards it to its own neighbors, ensuring that the information about Node A's existence is propagated further across the network.

8. **Address Request**: Additionally, Node A can also send a getaddr message to its neighbors, asking them to return a list of IP addresses of other peers.

```plaintext
Getaddr Message from Node A to Node B:
- Requesting IP Addresses of Other Peers
```

9. **Peer Discovery**: In response to the getaddr message, Node B and other peers will send addr messages back to Node A, containing lists of IP addresses of other peers, enabling Node A to discover additional nodes to connect to and further expand its network reach.

```plaintext
Addr Message from Node B to Node A:
- List of IP Addresses of Other Peers: [Peer 1's IP], [Peer 2's IP], ...
```

In summary, through the exchange of addr messages, forwarding of address information by connected peers, and the request and response mechanism facilitated by getaddr messages, a new node can actively participate in the Bitcoin network, discover additional peers, and expand its network connections. This address propagation and discovery protocol ensure that the Bitcoin network remains well-connected and nodes can efficiently find and connect to each other.

Figure 5. Address propagation and discovery
![nodes](/f2.png)


10. **Establishing Diverse Paths**: A node must connect to several different peers to establish diverse paths into the Bitcoin network. This diversity ensures resilience against network disruptions and provides multiple routes for information propagation. However, these paths are not persistent because nodes in the network constantly join and leave. Thus, a node must continually discover new nodes to replace lost connections and assist other nodes in bootstrapping.

11. **Bootstrap with One Connection**: Initially, only one connection is needed for bootstrapping because the first connected node can introduce the new node to its own peers. These peers can then offer further introductions, facilitating the expansion of the new node's network connections. Connecting to more than a handful of nodes is unnecessary and wasteful of network resources.

12. **Maintaining Connection Information**: After bootstrapping, a node remembers its most recent successful peer connections. This information allows the node to quickly reestablish connections with its former peer network if it is rebooted or loses connections. If none of the former peers respond to its connection requests, the node can use seed nodes again to bootstrap and discover new peers.

To maintain connectivity and resilience in the Bitcoin network, nodes establish diverse paths by connecting to multiple peers. They continually discover new nodes to replace lost connections and assist in bootstrapping other nodes. Despite the dynamic nature of the network, nodes can efficiently maintain connections by remembering recent peer connections and utilizing seed nodes when necessary.

It appears you're requesting a fix for the provided text regarding Bitcoin peer connections and management. Below is the revised version:

---

On a node running the Bitcoin Core client, you can list the peer connections with the command `getpeerinfo`:

```shell
$ bitcoin-cli getpeerinfo
 [
    {
        "addr" : "85.213.199.39:8333",
        "services" : "00000001",
        "lastsend" : 1405634126,
        "lastrecv" : 1405634127,
        "bytessent" : 23487651,
        "bytesrecv" : 138679099,
        "conntime" : 1405021768,
        "pingtime" : 0.00000000,
        "version" : 70002,
        "subver" : "/Satoshi:0.9.2.1/",
        "inbound" : false,
        "startingheight" : 310131,
        "banscore" : 0,
        "syncnode" : true
    },
    {
        "addr" : "58.23.244.20:8333",
        "services" : "00000001",
        "lastsend" : 1405634127,
        "lastrecv" : 1405634124,
        "bytessent" : 4460918,
        "bytesrecv" : 8903575,
        "conntime" : 1405559628,
        "pingtime" : 0.00000000,
        "version" : 70001,
        "subver" : "/Satoshi:0.8.6/",
        "inbound" : false,
        "startingheight" : 311074,
        "banscore" : 0,
        "syncnode" : false
    }
]
```

To override the automatic management of peers and specify a list of IP addresses, users can provide the option `-connect=<IPAddress>` and specify one or more IP addresses. If this option is used, the node will only connect to the selected IP addresses, instead of discovering and maintaining the peer connections automatically.

If there is no traffic on a connection, nodes will periodically send a message to maintain the connection. If a node has not communicated on a connection for more than 90 minutes, it is assumed to be disconnected, and a new peer will be sought. Thus, the network dynamically adjusts to transient nodes and network problems, and can organically grow and shrink as needed without any central control.


---

# Full Nodes

Full Nodes
Full nodes, often referred to as "full blockchain nodes," maintain a complete and up-to-date copy of the entire blockchain, containing all transactions. Historically, all nodes in the early years of Bitcoin were full nodes, and the Bitcoin Core client remains a prominent example of such a node. However, in recent years, there have been introductions of new types of Bitcoin clients known as lightweight clients, which do not maintain a full blockchain. We'll delve deeper into these lightweight clients in the following section.

A full blockchain node independently constructs and verifies the complete bitcoin blockchain, starting from the genesis block and extending to the latest known block in the network. It is capable of autonomously and authoritatively validating any transaction without relying on any external node or source of information. To stay updated, a full blockchain node relies on the network to receive information about new blocks of transactions, which it then verifies and integrates into its local blockchain copy.

Running a full blockchain node offers the quintessential Bitcoin experience: self-reliant verification of all transactions without dependence on or trust in external systems. Identifying a full node is relatively straightforward, as it necessitates over one hundred gigabytes of persistent storage (disk space) to accommodate the entire blockchain. If the synchronization process with the network takes two to three days and requires significant disk space, it indicates that you are running a full node. This requirement reflects the commitment to achieving complete independence and freedom from centralized authority.

Various alternative implementations of full blockchain Bitcoin clients exist, employing different programming languages and software architectures. Nonetheless, the most prevalent implementation remains the reference client, Bitcoin Core, also known as the Satoshi client. Over 75% of the nodes in the Bitcoin network run different versions of Bitcoin Core. This implementation is identifiable as "Satoshi" in the sub-version string transmitted in the version message, as demonstrated by the `getpeerinfo` command earlier, such as `/Satoshi:0.8.6/`.

